# MultiGridDet Test Suite

This directory contains test scripts to verify the correctness of MultiGridDet's core functionality, particularly the 9-cell assignment mechanism and y_true encoding/decoding pipeline.

## Test Scripts

### 1. `test_9cell_alignment.py`

**Purpose**: Verifies that all 9 cells in a 3x3 grid neighborhood decode to the **exact same** box coordinates. This is the core MultiGridDet innovation - multiple grid cells predict the same object, ensuring robust detection.

**What it tests**:
- Encoding: Verifies that `tf_preprocess_true_boxes` correctly encodes a single box to 9 different grid cells
- Decoding: Verifies that all 9 cells decode back to identical box coordinates (center and dimensions)
- Alignment precision: Checks that decoded boxes are within 1 pixel of the target (typically < 0.01 pixels)

**Usage**:
```bash
# Run from project root
python tests/test_9cell_alignment.py

# Or using conda environment
conda run -n cv_modern python tests/test_9cell_alignment.py
```

**Expected Output**:
- For each layer that contains the test box, it will show:
  - Grid positions of all 9 cells
  - Raw xy values (should be different for each cell)
  - Decoded box centers (should be identical for all 9 cells)
  - Alignment statistics (std dev should be < 0.01 pixels)
  - Width/height alignment (should be perfect)

**Key Validation**:
- ✓ All 9 cells decode to the same center (max deviation < 1 pixel)
- ✓ All 9 cells decode to the same width/height
- ✓ Raw_xy values are correctly different for each cell (compensating for cell_grid offsets)

---

### 2. `visualize_y_true.py`

**Purpose**: Visualizes and validates the y_true assignments generated by `tf_preprocess_true_boxes`. Creates visual output showing original annotation boxes vs decoded y_true boxes to verify correctness.

**What it tests**:
- y_true encoding: Verifies that `tf_preprocess_true_boxes` correctly encodes boxes
- y_true decoding: Verifies that decoding logic matches the encoder
- 9-cell alignment: Shows that all 9 cells for the same object decode to overlapping boxes
- Grid cell assignment: Visualizes which grid cells are assigned to each object

**Usage**:
```bash
# Basic usage (from project root)
python tests/visualize_y_true.py \
    --annotation data/coco_val2017.txt \
    --config configs/train_config.yaml \
    --output tests/y_true_visualization.png

# With deduplication (show only one box per object, removes 9-cell duplicates)
python tests/visualize_y_true.py \
    --annotation data/coco_val2017.txt \
    --config configs/train_config.yaml \
    --output tests/y_true_visualization.png \
    --deduplicate

# With augmentation (for testing augmentation pipeline)
python tests/visualize_y_true.py \
    --annotation data/coco_val2017.txt \
    --config configs/train_config.yaml \
    --output tests/y_true_visualization.png \
    --augment

# Or using conda environment
conda run -n cv_modern python tests/visualize_y_true.py \
    --annotation data/coco_val2017.txt \
    --config configs/train_config.yaml \
    --output tests/y_true_visualization.png \
    --deduplicate
```

**Arguments**:
- `--annotation`: Path to annotation file or annotation line string
- `--config`: Path to training config YAML file
- `--output`: Output path for visualization image (default: `y_true_visualization.png`)
- `--deduplicate`: Only show one box per object (removes 9-cell duplicates for cleaner visualization)
- `--augment`: Enable data augmentation (default: False, for testing)

**Output**:
- Creates a visualization image with:
  - Original annotation boxes (green)
  - Decoded boxes from each layer (different colors per layer)
  - Grid overlay showing grid cell boundaries
  - Labels showing class, anchor index, and grid position

**Key Validation**:
- ✓ All 9 cells for the same object decode to overlapping boxes
- ✓ Decoded boxes match original annotation boxes
- ✓ Grid cell assignments are correct (3x3 neighborhood)

---

## Running All Tests

To run all tests and verify MultiGridDet is working correctly:

```bash
# From project root
cd /home/solufast/pythondev/MyPhDProjects/MultiGridDet

# Run 9-cell alignment test
python tests/test_9cell_alignment.py

# Run visualization test
python tests/visualize_y_true.py \
    --annotation data/coco_val2017.txt \
    --config configs/train_config.yaml \
    --output tests/y_true_visualization.png \
    --deduplicate

# Or using conda environment
conda run -n cv_modern python tests/test_9cell_alignment.py
conda run -n cv_modern python tests/visualize_y_true.py \
    --annotation data/coco_val2017.txt \
    --config configs/train_config.yaml \
    --output tests/y_true_visualization.png \
    --deduplicate
```

## Technical Details

### 9-Cell Assignment Mechanism

MultiGridDet assigns each object to a 3x3 neighborhood of grid cells (9 cells total). Each cell stores:
- **Different raw_xy values**: These compensate for the cell's grid position
- **Same raw_wh values**: Width and height are the same for all cells
- **Same class and anchor**: All cells predict the same object

The key innovation is the `tanh(0.15*x) + sigmoid(0.15*x)` activation function, which has a range of `[-1, 2]`, allowing offsets to span the 3x3 neighborhood while ensuring all cells decode to the same final box coordinates.

### Encoding Process

1. **Box to grid assignment**: Box center is mapped to grid coordinates
2. **3x3 neighborhood**: All 9 cells in the neighborhood are candidates
3. **Offset calculation**: For each cell, compute desired offset = (box_xy_grid) - cell_grid
4. **Numerical inversion**: Invert `tanh + sigmoid` activation to get raw_xy targets
5. **Width/height encoding**: Compute `log(box_wh / anchor_wh)`

### Decoding Process

1. **Activation**: Apply `tanh(0.15*raw_xy) + sigmoid(0.15*raw_xy)`
2. **Add cell_grid**: `box_xy_grid = activated_xy + cell_grid`
3. **Normalize**: `box_xy_normalized = box_xy_grid / grid_size`
4. **Convert to pixels**: `abs_xy = box_xy_normalized * input_shape`
5. **Decode wh**: `box_wh = anchor * exp(raw_wh) / input_shape`

### Verification

Both tests verify that:
- Encoding and decoding are mathematically consistent
- All 9 cells produce identical final box coordinates
- The numerical inversion is precise enough (< 0.01 pixel error)
- Grid cell indexing matches between encoder and decoder

---

## Troubleshooting

### Test fails with "Boxes are NOT aligned"

If `test_9cell_alignment.py` shows boxes are not aligned:
1. Check that `tf_preprocess_true_boxes` is being used (not the old NumPy version)
2. Verify grid dimensions match between encoding and decoding
3. Check that `cell_grid` indexing is correct: `cell_grid[i, j] = [j, i]`

### Visualization shows shifted boxes

If `visualize_y_true.py` shows boxes shifted by grid cell size:
1. Ensure you're using `tf_preprocess_true_boxes` directly (not through generator)
2. Verify `input_shape` matches between config and actual processing
3. Check that grid dimensions are extracted from `y_true.shape`, not computed

### Import errors

If you get import errors:
```bash
# Make sure you're running from project root
cd /home/solufast/pythondev/MyPhDProjects/MultiGridDet
python tests/test_9cell_alignment.py
```

---

## Related Files

- `multigriddet/data/generators.py`: Contains `tf_preprocess_true_boxes` (the function being tested)
- `multigriddet/postprocess/multigrid_decode.py`: Contains the decoding logic (reference implementation)
- `configs/train_config.yaml`: Training configuration used by visualization script

